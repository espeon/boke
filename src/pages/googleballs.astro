---
import Layout from "../layouts/Nothing.astro";
---

<Layout title="gogogle balls" description="gmaougle balls">
  <canvas id="c" width="400" height="400" style="background:transparent;"
  ></canvas>
  <script is:inline>
    class Vector {
      constructor(x = 0, y = 0, z = 0) {
        this.x = x;
        this.y = y;
        this.z = z;
      }

      set(x, y, z = this.z) {
        this.x = x;
        this.y = y;
        this.z = z;
      }
    }

    class Point {
      constructor(x, y, z, size, colour) {
        this.colour = colour;
        this.curPos = new Vector(x, y, z);
        this.friction = 0.4;
        this.originalPos = new Vector(x, y, z);
        this.radius = size;
        this.size = size;
        this.springStrength = 0.9;
        this.targetPos = new Vector(x, y, z);
        this.velocity = new Vector();
      }

      update(dt) {
        // x axis
        const dx = this.targetPos.x - this.curPos.x;
        const ax = dx * this.springStrength;
        this.velocity.x =
          (this.velocity.x + ax * dt) * Math.pow(this.friction, dt);
        this.curPos.x += this.velocity.x * dt;

        // y axis
        const dy = this.targetPos.y - this.curPos.y;
        const ay = dy * this.springStrength;
        this.velocity.y =
          (this.velocity.y + ay * dt) * Math.pow(this.friction, dt);
        this.curPos.y += this.velocity.y * dt;

        // z axis (depth based on distance from original)
        const dox = this.originalPos.x - this.curPos.x;
        const doy = this.originalPos.y - this.curPos.y;
        const dd = dox * dox + doy * doy;
        const d = Math.sqrt(dd);

        this.targetPos.z = d / 100 + 1;
        const dz = this.targetPos.z - this.curPos.z;
        const az = dz * this.springStrength;
        this.velocity.z =
          (this.velocity.z + az * dt) * Math.pow(this.friction, dt);
        this.curPos.z += this.velocity.z * dt;

        this.radius = Math.max(1, this.size * this.curPos.z);
      }

      checkProximity(mousePos, repelDistance) {
        const dx = mousePos.x - this.curPos.x;
        const dy = mousePos.y - this.curPos.y;
        const distSq = dx * dx + dy * dy;
        const repelDistSq = repelDistance * repelDistance;

        if (distSq < repelDistSq) {
          this.targetPos.x = this.curPos.x - dx;
          this.targetPos.y = this.curPos.y - dy;
        } else {
          this.targetPos.x = this.originalPos.x;
          this.targetPos.y = this.originalPos.y;
        }
      }

      draw(ctx) {
        ctx.fillStyle = this.colour;
        ctx.beginPath();
        ctx.arc(this.curPos.x, this.curPos.y, this.radius, 0, Math.PI * 2);
        ctx.fill();
      }
    }

    class ParticleSystem {
      constructor(canvasEl, particleData) {
        this.canvas = canvasEl;
        this.ctx = canvasEl.getContext("2d");
        this.points = particleData.map(
          ([x, y, size, colour]) => new Point(x, y, 0, size, colour),
        );
        this.mousePos = new Vector();
        this.repelDistance = 150;

        this.lastFrameTime = performance.now();

        this.init();
      }

      init() {
        this.updateCanvasDimensions();
        this.setupEventListeners();
        this.animate();
      }

      updateCanvasDimensions() {
        this.canvas.width = window.innerWidth;
        this.canvas.height = window.innerHeight;

        const offsetX = this.canvas.width / 2 - 180;
        const offsetY = this.canvas.height / 2 - 65;

        // just set positions directly, don't try to be clever with relative calcs
        this.points.forEach((point) => {
          point.originalPos.x = offsetX + point.originalPos.x;
          point.originalPos.y = offsetY + point.originalPos.y;
          point.curPos.set(point.originalPos.x, point.originalPos.y);
          point.targetPos.set(point.originalPos.x, point.originalPos.y);
        });
      }

      setupEventListeners() {
        window.addEventListener("resize", () => this.updateCanvasDimensions());
        window.addEventListener("mousemove", (e) => {
          this.mousePos.set(e.clientX, e.clientY);
        });
        this.canvas.addEventListener(
          "touchmove",
          (e) => {
            e.preventDefault();
            const touch = e.touches[0];
            this.mousePos.set(touch.clientX, touch.clientY);
          },
          { passive: false },
        );
      }

      animate = () => {
        const now = performance.now();
        const dt = Math.min((now - this.lastFrameTime) / 100, 0.1);
        this.lastFrameTime = now;

        this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);

        this.points.forEach((point) => {
          point.checkProximity(this.mousePos, this.repelDistance);
          point.update(dt);
          point.draw(this.ctx);
        });

        requestAnimationFrame(() => this.animate());
      };
    }

    // init with your data
    const particleData = [
      [202, 78, 9, "#ed9d33"],
      [348, 83, 9, "#d44d61"],
      [256, 69, 9, "#4f7af2"],
      [214, 59, 9, "#ef9a1e"],
      [265, 36, 9, "#4976f3"],
      [300, 78, 9, "#269230"],
      [294, 59, 9, "#1f9e2c"],
      [45, 88, 9, "#1c48dd"],
      [268, 52, 9, "#2a56ea"],
      [73, 83, 9, "#3355d8"],
      [294, 6, 9, "#36b641"],
      [235, 62, 9, "#2e5def"],
      [353, 42, 8, "#d53747"],
      [336, 52, 8, "#eb676f"],
      [208, 41, 8, "#f9b125"],
      [321, 70, 8, "#de3646"],
      [8, 60, 8, "#2a59f0"],
      [180, 81, 8, "#eb9c31"],
      [146, 65, 8, "#c41731"],
      [145, 49, 8, "#d82038"],
      [246, 34, 8, "#5f8af8"],
      [169, 69, 8, "#efa11e"],
      [273, 99, 8, "#2e55e2"],
      [248, 120, 8, "#4167e4"],
      [294, 41, 8, "#0b991a"],
      [267, 114, 8, "#4869e3"],
      [78, 67, 8, "#3059e3"],
      [294, 23, 8, "#10a11d"],
      [117, 83, 8, "#cf4055"],
      [137, 80, 8, "#cd4359"],
      [14, 71, 8, "#2855ea"],
      [331, 80, 8, "#ca273c"],
      [25, 82, 8, "#2650e1"],
      [233, 46, 8, "#4a7bf9"],
      [73, 13, 8, "#3d65e7"],
      [327, 35, 6, "#f47875"],
      [319, 46, 6, "#f36764"],
      [256, 81, 6, "#1d4eeb"],
      [244, 88, 6, "#698bf1"],
      [194, 32, 6, "#fac652"],
      [97, 56, 6, "#ee5257"],
      [105, 75, 6, "#cf2a3f"],
      [42, 4, 6, "#5681f5"],
      [10, 27, 6, "#4577f6"],
      [166, 55, 6, "#f7b326"],
      [266, 88, 6, "#2b58e8"],
      [178, 34, 6, "#facb5e"],
      [100, 65, 6, "#e02e3d"],
      [343, 32, 6, "#f16d6f"],
      [59, 5, 6, "#507bf2"],
      [27, 9, 6, "#5683f7"],
      [233, 116, 6, "#3158e2"],
      [123, 32, 6, "#f0696c"],
      [6, 38, 6, "#3769f6"],
      [63, 62, 6, "#6084ef"],
      [6, 49, 6, "#2a5cf4"],
      [108, 36, 6, "#f4716e"],
      [169, 43, 6, "#f8c247"],
      [137, 37, 6, "#e74653"],
      [318, 58, 6, "#ec4147"],
      [226, 100, 5, "#4876f1"],
      [101, 46, 5, "#ef5c5c"],
      [226, 108, 5, "#2552ea"],
      [17, 17, 5, "#4779f7"],
      [232, 93, 5, "#4b78f1"],
    ];

    const canvas = document.getElementById("c");
    new ParticleSystem(canvas, particleData);
  </script>
</Layout>
